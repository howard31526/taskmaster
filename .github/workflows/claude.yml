name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
        continue-on-error: true

      - name: Analyze Error
        if: steps.claude.outcome == 'failure'
        env:
          ERROR_OUTPUT: ${{ steps.claude.outputs.error }}
        run: |
          echo "::group::ğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)"
          echo "$ERROR_OUTPUT"
          echo "::endgroup::"
          
          echo ""
          echo "ğŸ” åˆ†æéŒ¯èª¤é¡å‹..."
          echo ""
          
          # ===== èª¿è©¦å€å¡Šï¼šé¡¯ç¤ºæå–éç¨‹ =====
          echo "::group::ğŸ› èª¿è©¦ï¼šæå– result æ¬„ä½"
          echo "æ­¥é©Ÿ 1: æœå°‹æ‰€æœ‰ result æ¬„ä½..."
          echo "$ERROR_OUTPUT" | grep -o '"result"[[:space:]]*:[[:space:]]*"[^"]*"' || echo "  (æœªæ‰¾åˆ°åŒ¹é…)"
          echo ""
          echo "æ­¥é©Ÿ 2: æå–æœ€å¾Œä¸€å€‹ result å€¼..."
          RESULT_MESSAGE=$(echo "$ERROR_OUTPUT" | grep -o '"result"[[:space:]]*:[[:space:]]*"[^"]*"' | tail -n1 | sed 's/"result"[[:space:]]*:[[:space:]]*"\(.*\)"/\1/')
          echo "  æå–çµæœ: '$RESULT_MESSAGE'"
          echo "::endgroup::"
          # ===== èª¿è©¦å€å¡ŠçµæŸ =====
          
          # å¦‚æœç¬¬ä¸€ç¨®æ–¹æ³•å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•
          if [ -z "$RESULT_MESSAGE" ]; then
            RESULT_MESSAGE=$(echo "$ERROR_OUTPUT" | grep -oP '"result"\s*:\s*"\K[^"]+' | tail -n1)
          fi
          
          echo "::group::ğŸ” æå–çš„éŒ¯èª¤è¨Šæ¯"
          echo "Result: $RESULT_MESSAGE"
          echo "::endgroup::"
          
          # åˆå§‹åŒ–è®Šæ•¸
          ERROR_TYPE="UNKNOWN"
          ERROR_DETAIL=""
          NEXT_STEPS=""
          RESET_TIME=""
          
          # ä½¿ç”¨ result è¨Šæ¯é€²è¡ŒéŒ¯èª¤åˆ†é¡
          ERROR_LOG="$RESULT_MESSAGE"
          
          # 1. OAuth Token Revoked - æœ€å¸¸è¦‹çš„èªè­‰å•é¡Œ
          if echo "$ERROR_LOG" | grep -qi "OAuth token revoked\|token revoked"; then
            ERROR_TYPE="ğŸ” OAUTH_REVOKED"
            ERROR_DETAIL="OAuth Token å·²è¢«æ’¤éŠ·æˆ–å¤±æ•ˆ"
            NEXT_STEPS="1. ğŸ“± é‡æ–°ç™»å…¥ Claude Code ä¸¦æˆæ¬Š GitHubï¼š
             æ–¹æ³• Aï¼šåœ¨æœ¬åœ°çµ‚ç«¯åŸ·è¡Œ
               $ claude code /login
             æ–¹æ³• Bï¼šå‰å¾€ç¶²é æˆæ¬Š
               https://claude.ai/settings/integrations
          
          2. âœ… ç¢ºèª GitHub App å®‰è£ç‹€æ…‹ï¼š
             https://github.com/settings/installations
             ç¢ºä¿ã€ŒClaude Codeã€App å·²å®‰è£ä¸¦æœ‰å­˜å–æ­¤ repo çš„æ¬Šé™
          
          3. ğŸ”„ å¦‚æœé‡æ–°ç™»å…¥å¾Œä»æœ‰å•é¡Œï¼š
             - ç§»é™¤ GitHub App (ä¸Šæ–¹é€£çµ)
             - é‡æ–°å®‰è£ä¸¦æˆæ¬Š Claude Code
          
          4. âš ï¸  æ³¨æ„äº‹é …ï¼š
             - Token ç”± Claude ç³»çµ±è‡ªå‹•ç®¡ç†
             - ä¸éœ€è¦æ‰‹å‹•åœ¨ GitHub Secrets ä¸­è¨­å®š
             - é‡æ–° /login å¾Œæœƒè‡ªå‹•æ›´æ–°"
          
          # 2. Session Limit - æ¯æ—¥ä½¿ç”¨é¡åº¦
          elif echo "$ERROR_LOG" | grep -qi "session.limit\|session limit reached\|session limit\|usage limit"; then
            ERROR_TYPE="â° SESSION_LIMIT"
            ERROR_DETAIL="Claude æ¯æ—¥ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™"
            
            # å˜—è©¦æå–é‡ç½®æ™‚é–“
            RESET_TIME=$(echo "$ERROR_LOG" | grep -oP "resets.*?(\d+[ap]m)" | head -n1)
            if [ -z "$RESET_TIME" ]; then
              RESET_TIME=$(echo "$ERROR_LOG" | grep -oP "\d+[ap]m" | head -n1)
            fi
            
            NEXT_STEPS="1. ğŸ“Š æŸ¥çœ‹è©³ç´°ä½¿ç”¨ç‹€æ…‹ï¼š
             https://claude.ai (æŸ¥çœ‹å³ä¸Šè§’çš„ä½¿ç”¨é‡æŒ‡ç¤º)
          
          2. â³ ç­‰å¾…é¡åº¦é‡ç½®"
            
            if [ -n "$RESET_TIME" ]; then
              NEXT_STEPS="${NEXT_STEPS}
             é è¨ˆé‡ç½®æ™‚é–“ï¼š$RESET_TIME"
            fi
            
            NEXT_STEPS="${NEXT_STEPS}
          
          3. ğŸ’ è€ƒæ…®å‡ç´šæ–¹æ¡ˆï¼š
             - Pro æ–¹æ¡ˆæœ‰æ›´é«˜çš„ä½¿ç”¨é¡åº¦
             - å‰å¾€ https://claude.ai/settings/plan æŸ¥çœ‹æ–¹æ¡ˆé¸é …"
          
          # 3. Rate Limit - API é€Ÿç‡é™åˆ¶
          elif echo "$ERROR_LOG" | grep -qi "rate.limit\|rate limit\|429\|too many requests"; then
            ERROR_TYPE="ğŸš¦ RATE_LIMIT"
            ERROR_DETAIL="API è«‹æ±‚é€Ÿç‡é™åˆ¶ï¼ˆæš«æ™‚æ€§ï¼‰"
            NEXT_STEPS="1. â±ï¸  é€™æ˜¯çŸ­æ™‚é–“å…§è«‹æ±‚éå¤šé€ æˆçš„æš«æ™‚é™åˆ¶
          2. â˜• ç­‰å¾… 2-5 åˆ†é˜å¾Œé‡è©¦
          3. â„¹ï¸  é€™ä¸æ˜¯æ¯æ—¥é¡åº¦å•é¡Œï¼Œåªæ˜¯é€Ÿç‡ä¿è­·æ©Ÿåˆ¶"
          
          # 4. ä¸€èˆ¬èªè­‰éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "unauthorized\|authentication.*failed\|invalid.*token\|401\|403"; then
            ERROR_TYPE="ğŸ”’ AUTHENTICATION"
            ERROR_DETAIL="èªè­‰å¤±æ•—"
            NEXT_STEPS="1. ğŸ” æª¢æŸ¥ GitHub App å®‰è£ï¼š
             https://github.com/settings/installations
          
          2. âœ… ç¢ºèªã€ŒClaude Codeã€App æ¬Šé™ï¼š
             - å·²å®‰è£
             - æœ‰å­˜å–æ­¤ repository çš„æ¬Šé™
          
          3. ğŸ”„ å˜—è©¦é‡æ–°å®‰è£ï¼š
             - ç§»é™¤èˆŠçš„å®‰è£
             - é‡æ–°åŸ·è¡Œ 'claude code /login'"
          
          # 5. æ¬Šé™éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "permission.*denied\|forbidden\|not.*allowed"; then
            ERROR_TYPE="â›” PERMISSION"
            ERROR_DETAIL="æ¬Šé™ä¸è¶³"
            NEXT_STEPS="1. ğŸ“ æª¢æŸ¥ workflow çš„ permissions è¨­å®š
          2. ğŸ”‘ ç¢ºèª GitHub App æœ‰è¶³å¤ æ¬Šé™
          3. âš™ï¸  æª¢æŸ¥ repository Settings â†’ Actions â†’ General"
          
          # 6. å…¶ä»–åŒ…å« "error" çš„è¨Šæ¯
          elif echo "$ERROR_LOG" | grep -qi "error"; then
            ERROR_TYPE="âš ï¸  GENERAL_ERROR"
            ERROR_DETAIL="ç™¼ç”ŸéŒ¯èª¤"
            NEXT_STEPS="1. ğŸ“‹ æŸ¥çœ‹ä¸Šæ–¹å®Œæ•´éŒ¯èª¤è¨Šæ¯
          2. ğŸ” å¸¸è¦‹åŸå› æª¢æŸ¥ï¼š
             - OAuth token å•é¡Œ â†’ åŸ·è¡Œ 'claude code /login'
             - ä½¿ç”¨é¡åº¦å•é¡Œ â†’ å‰å¾€ https://claude.ai æŸ¥çœ‹
             - ç¶²è·¯æˆ– API å•é¡Œ â†’ ç¨å¾Œé‡è©¦"
          fi
          
          # é¡¯ç¤ºåˆ†é¡çµæœ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ "$ERROR_TYPE" != "UNKNOWN" ]; then
            echo "::error title=$ERROR_TYPE::$ERROR_DETAIL"
            echo ""
            echo "# ğŸš¨ $ERROR_TYPE"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ’¡ èªªæ˜"
            echo ""
            echo "$ERROR_DETAIL"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "â° **é‡ç½®æ™‚é–“ï¼š** \`$RESET_TIME\`"
              echo ""
            fi
            echo "## ğŸ”§ è™•ç†æ­¥é©Ÿ"
            echo ""
            echo "$NEXT_STEPS"
          else
            echo "::warning title=æœªåˆ†é¡éŒ¯èª¤::è«‹æŸ¥çœ‹å®Œæ•´éŒ¯èª¤è¼¸å‡º"
            echo ""
            echo "# âš ï¸  ç„¡æ³•è‡ªå‹•åˆ†é¡æ­¤éŒ¯èª¤"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            if [ -n "$RESULT_MESSAGE" ]; then
              echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
              echo ""
              echo "\`\`\`"
              echo "$RESULT_MESSAGE"
              echo "\`\`\`"
              echo ""
            fi
            echo "## ğŸ“‹ å»ºè­°æª¢æŸ¥æ­¥é©Ÿ"
            echo ""
            echo "1. ğŸ“„ æŸ¥çœ‹ä¸Šæ–¹ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)ã€å€å¡Š"
            echo "2. ğŸ” æœ€å¸¸è¦‹å•é¡Œï¼š"
            echo "   - OAuth Token å¤±æ•ˆ â†’ åŸ·è¡Œ \`claude code /login\`"
            echo "   - ä½¿ç”¨é¡åº¦ä¸è¶³ â†’ https://claude.ai"
            echo "3. ğŸ› å¦‚å•é¡ŒæŒçºŒï¼Œè«‹å°‡å®Œæ•´éŒ¯èª¤è²¼åˆ° GitHub Issue"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "::notice::ğŸ’¡ å®Œæ•´çš„ JSON éŒ¯èª¤è¼¸å‡ºå·²æ‘ºç–Šåœ¨ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)ã€å€å¡Šä¸­"
          
          exit 1
