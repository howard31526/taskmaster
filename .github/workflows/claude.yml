name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
        continue-on-error: true

      - name: Analyze Error
        if: steps.claude.outcome == 'failure'
        run: |
          # è®€å–åŸ·è¡Œè¼¸å‡ºæª”æ¡ˆ
          EXECUTION_FILE="${{ steps.claude.outputs.execution_file }}"
          
          if [ ! -f "$EXECUTION_FILE" ]; then
            echo "::error::æ‰¾ä¸åˆ°åŸ·è¡Œè¼¸å‡ºæª”æ¡ˆ: $EXECUTION_FILE"
            exit 1
          fi
          
          # è®€å–æª”æ¡ˆå…§å®¹ä¸¦æå–éŒ¯èª¤è¨Šæ¯
          RESULT_MESSAGE=$(grep -oP '"result"\s*:\s*"\K[^"]+' "$EXECUTION_FILE" | tail -n1)
          
          if [ -z "$RESULT_MESSAGE" ]; then
            echo "::warning::ç„¡æ³•å¾è¼¸å‡ºæª”æ¡ˆä¸­æå–éŒ¯èª¤è¨Šæ¯"
            echo "è«‹æŸ¥çœ‹ä¸Šæ–¹ Run Claude Code æ­¥é©Ÿçš„æ—¥èªŒ"
            exit 1
          fi
          
          # æ ¹æ“šéŒ¯èª¤è¨Šæ¯åˆ†é¡ä¸¦é¡¯ç¤ºå°æ‡‰çš„è§£æ±ºæ–¹æ¡ˆ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # 1. OAuth Token å•é¡Œ
          if echo "$RESULT_MESSAGE" | grep -qi "OAuth token revoked\|token revoked"; then
            echo "::error title=ğŸ” OAuth Token å·²æ’¤éŠ·::è«‹é‡æ–°ç™»å…¥æˆæ¬Š"
            echo ""
            echo "# ğŸ” OAuth Token å·²æ’¤éŠ·"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ”§ è§£æ±ºæ­¥é©Ÿ"
            echo ""
            echo "### 1. é‡æ–°ç™»å…¥ Claude Code"
            echo ""
            echo "åœ¨æœ¬åœ°çµ‚ç«¯åŸ·è¡Œï¼š"
            echo ""
            echo "\`\`\`bash"
            echo "claude code /login"
            echo "\`\`\`"
            echo ""
            echo "### 2. ç¢ºèª GitHub App å®‰è£"
            echo ""
            echo "å‰å¾€ï¼šhttps://github.com/settings/installations"
            echo ""
            echo "ç¢ºä¿ï¼š"
            echo "- âœ… ã€ŒClaude Codeã€App å·²å®‰è£"
            echo "- âœ… æœ‰æ¬Šé™å­˜å–æ­¤ repository (\`${{ github.repository }}\`)"
            echo ""
            echo "### 3. å¦‚æœå•é¡ŒæŒçºŒ"
            echo ""
            echo "- ğŸ—‘ï¸  ç§»é™¤èˆŠçš„ GitHub App å®‰è£"
            echo "- ğŸ”„ é‡æ–°åŸ·è¡Œ \`claude code /login\`"
          
          # 2. Session Limit
          elif echo "$RESULT_MESSAGE" | grep -qi "session.limit\|session limit\|usage limit"; then
            RESET_TIME=$(echo "$RESULT_MESSAGE" | grep -oP "\d+[ap]m" | head -n1)
            
            echo "::error title=â° ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™::ç­‰å¾…é¡åº¦é‡ç½®"
            echo ""
            echo "# â° ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "â° **é¡åº¦é‡ç½®æ™‚é–“ï¼š** \`$RESET_TIME\`"
              echo ""
            fi
            echo "## ğŸ”§ è§£æ±ºæ­¥é©Ÿ"
            echo ""
            echo "### 1. æŸ¥çœ‹ä½¿ç”¨ç‹€æ…‹"
            echo ""
            echo "å‰å¾€ï¼šhttps://claude.ai"
            echo ""
            echo "æŸ¥çœ‹å³ä¸Šè§’çš„ä½¿ç”¨é‡æŒ‡ç¤ºå™¨"
            echo ""
            echo "### 2. ç­‰å¾…é¡åº¦é‡ç½®"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "é è¨ˆåœ¨ **$RESET_TIME** é‡ç½®"
            else
              echo "é¡åº¦é€šå¸¸æ¯å¤©é‡ç½®"
            fi
            echo ""
            echo "### 3. å‡ç´šæ–¹æ¡ˆï¼ˆå¯é¸ï¼‰"
            echo ""
            echo "å‰å¾€ï¼šhttps://claude.ai/settings/plan"
            echo ""
            echo "Pro æ–¹æ¡ˆæä¾›æ›´é«˜çš„ä½¿ç”¨é¡åº¦"
          
          # 3. Rate Limit
          elif echo "$RESULT_MESSAGE" | grep -qi "rate.limit\|rate limit\|429\|too many requests"; then
            echo "::error title=ğŸš¦ API é€Ÿç‡é™åˆ¶::è«‹ç¨å¾Œé‡è©¦"
            echo ""
            echo "# ğŸš¦ API é€Ÿç‡é™åˆ¶"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ’¡ èªªæ˜"
            echo ""
            echo "é€™æ˜¯çŸ­æ™‚é–“å…§è«‹æ±‚éå¤šé€ æˆçš„**æš«æ™‚æ€§é™åˆ¶**"
            echo ""
            echo "## ğŸ”§ è§£æ±ºæ­¥é©Ÿ"
            echo ""
            echo "1. â±ï¸  ç­‰å¾… **2-5 åˆ†é˜**"
            echo "2. ğŸ”„ é‡æ–°è§¸ç™¼ workflow"
            echo "3. â„¹ï¸  é€™ä¸æ˜¯æ¯æ—¥é¡åº¦å•é¡Œ"
          
          # 4. èªè­‰éŒ¯èª¤
          elif echo "$RESULT_MESSAGE" | grep -qi "unauthorized\|authentication\|invalid.*token\|401\|403"; then
            echo "::error title=ğŸ”’ èªè­‰å¤±æ•—::è«‹æª¢æŸ¥æˆæ¬Šè¨­å®š"
            echo ""
            echo "# ğŸ”’ èªè­‰å¤±æ•—"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ”§ è§£æ±ºæ­¥é©Ÿ"
            echo ""
            echo "1. æª¢æŸ¥ GitHub Appï¼šhttps://github.com/settings/installations"
            echo "2. ç¢ºèªã€ŒClaude Codeã€App å·²å®‰è£ä¸”æœ‰æ¬Šé™"
            echo "3. é‡æ–°åŸ·è¡Œ \`claude code /login\`"
          
          # 5. å…¶ä»–éŒ¯èª¤
          else
            echo "::error title=âš ï¸ åŸ·è¡Œå¤±æ•—::$RESULT_MESSAGE"
            echo ""
            echo "# âš ï¸  åŸ·è¡Œå¤±æ•—"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ” å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆ"
            echo ""
            echo "1. ğŸ” OAuth Token å•é¡Œ â†’ \`claude code /login\`"
            echo "2. â° ä½¿ç”¨é¡åº¦å•é¡Œ â†’ https://claude.ai"
            echo "3. ğŸ”„ ç¶²è·¯æˆ–æš«æ™‚æ€§å•é¡Œ â†’ é‡è©¦"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          exit 1
