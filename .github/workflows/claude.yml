name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
        continue-on-error: true

      - name: Analyze Error
        if: steps.claude.outcome == 'failure'
        run: |
          # 讀取執行輸出檔案
          EXECUTION_FILE="${{ steps.claude.outputs.execution_file }}"
          
          if [ ! -f "$EXECUTION_FILE" ]; then
            echo "::error::找不到執行輸出檔案: $EXECUTION_FILE"
            exit 1
          fi
          
          # 讀取檔案內容並提取錯誤訊息
          RESULT_MESSAGE=$(grep -oP '"result"\s*:\s*"\K[^"]+' "$EXECUTION_FILE" | tail -n1)
          
          if [ -z "$RESULT_MESSAGE" ]; then
            echo "::warning::無法從輸出檔案中提取錯誤訊息"
            echo "請查看上方 Run Claude Code 步驟的日誌"
            exit 1
          fi
          
          # 根據錯誤訊息分類並顯示對應的解決方案
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          # 1. OAuth Token 問題
          if echo "$RESULT_MESSAGE" | grep -qi "OAuth token revoked\|token revoked"; then
            echo "::error title=🔐 OAuth Token 已撤銷::請重新登入授權"
            echo ""
            echo "# 🔐 OAuth Token 已撤銷"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "## 📝 錯誤訊息"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## 🔧 解決步驟"
            echo ""
            echo "### 1. 重新登入 Claude Code"
            echo ""
            echo "在本地終端執行："
            echo ""
            echo "\`\`\`bash"
            echo "claude code /login"
            echo "\`\`\`"
            echo ""
            echo "### 2. 確認 GitHub App 安裝"
            echo ""
            echo "前往：https://github.com/settings/installations"
            echo ""
            echo "確保："
            echo "- ✅ 「Claude Code」App 已安裝"
            echo "- ✅ 有權限存取此 repository (\`${{ github.repository }}\`)"
            echo ""
            echo "### 3. 如果問題持續"
            echo ""
            echo "- 🗑️  移除舊的 GitHub App 安裝"
            echo "- 🔄 重新執行 \`claude code /login\`"
          
          # 2. Session Limit
          elif echo "$RESULT_MESSAGE" | grep -qi "session.limit\|session limit\|usage limit"; then
            RESET_TIME=$(echo "$RESULT_MESSAGE" | grep -oP "\d+[ap]m" | head -n1)
            
            echo "::error title=⏰ 使用額度已達上限::等待額度重置"
            echo ""
            echo "# ⏰ 使用額度已達上限"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "## 📝 錯誤訊息"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "⏰ **額度重置時間：** \`$RESET_TIME\`"
              echo ""
            fi
            echo "## 🔧 解決步驟"
            echo ""
            echo "### 1. 查看使用狀態"
            echo ""
            echo "前往：https://claude.ai"
            echo ""
            echo "查看右上角的使用量指示器"
            echo ""
            echo "### 2. 等待額度重置"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "預計在 **$RESET_TIME** 重置"
            else
              echo "額度通常每天重置"
            fi
            echo ""
            echo "### 3. 升級方案（可選）"
            echo ""
            echo "前往：https://claude.ai/settings/plan"
            echo ""
            echo "Pro 方案提供更高的使用額度"
          
          # 3. Rate Limit
          elif echo "$RESULT_MESSAGE" | grep -qi "rate.limit\|rate limit\|429\|too many requests"; then
            echo "::error title=🚦 API 速率限制::請稍後重試"
            echo ""
            echo "# 🚦 API 速率限制"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "## 📝 錯誤訊息"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## 💡 說明"
            echo ""
            echo "這是短時間內請求過多造成的**暫時性限制**"
            echo ""
            echo "## 🔧 解決步驟"
            echo ""
            echo "1. ⏱️  等待 **2-5 分鐘**"
            echo "2. 🔄 重新觸發 workflow"
            echo "3. ℹ️  這不是每日額度問題"
          
          # 4. 認證錯誤
          elif echo "$RESULT_MESSAGE" | grep -qi "unauthorized\|authentication\|invalid.*token\|401\|403"; then
            echo "::error title=🔒 認證失敗::請檢查授權設定"
            echo ""
            echo "# 🔒 認證失敗"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "## 📝 錯誤訊息"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## 🔧 解決步驟"
            echo ""
            echo "1. 檢查 GitHub App：https://github.com/settings/installations"
            echo "2. 確認「Claude Code」App 已安裝且有權限"
            echo "3. 重新執行 \`claude code /login\`"
          
          # 5. 其他錯誤
          else
            echo "::error title=⚠️ 執行失敗::$RESULT_MESSAGE"
            echo ""
            echo "# ⚠️  執行失敗"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "## 📝 錯誤訊息"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## 🔍 常見解決方案"
            echo ""
            echo "1. 🔐 OAuth Token 問題 → \`claude code /login\`"
            echo "2. ⏰ 使用額度問題 → https://claude.ai"
            echo "3. 🔄 網路或暫時性問題 → 重試"
          fi
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          exit 1
