name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
        continue-on-error: true

      - name: Analyze Error
        if: steps.claude.outcome == 'failure'
        run: |
          echo "::group::ğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º"
          ERROR_LOG="${{ steps.claude.outputs.error || '' }}"
          echo "$ERROR_LOG"
          echo "::endgroup::"
          
          echo ""
          echo "ğŸ” åˆ†æéŒ¯èª¤é¡å‹..."
          echo ""
          
          ERROR_TYPE="UNKNOWN"
          ERROR_DETAIL=""
          NEXT_STEPS=""
          RESET_TIME=""
          
          # 1. æª¢æŸ¥ Session Limitï¼ˆæœ€å¸¸è¦‹çš„å•é¡Œï¼‰
          if echo "$ERROR_LOG" | grep -qi "session.limit\|session limit reached\|session limit"; then
            ERROR_TYPE="SESSION_LIMIT"
            ERROR_DETAIL="Claude æ¯æ—¥ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™"
            RESET_TIME=$(echo "$ERROR_LOG" | grep -oP "resets \K[0-9]+[ap]m" | head -n1)
            NEXT_STEPS="
            1. å‰å¾€ https://claude.ai æŸ¥çœ‹è©³ç´°ä½¿ç”¨ç‹€æ…‹
            2. ç­‰å¾…ä½¿ç”¨é¡åº¦é‡ç½®"
              if [ -n "$RESET_TIME" ]; then
                NEXT_STEPS="${NEXT_STEPS}ï¼ˆé è¨ˆé‡ç½®æ™‚é–“ï¼š$RESET_TIMEï¼‰"
              fi
              NEXT_STEPS="${NEXT_STEPS}
            3. æˆ–è€ƒæ…®å‡ç´šåˆ°æ›´é«˜æ–¹æ¡ˆä»¥ç²å¾—æ›´å¤šé¡åº¦"
          
          # 2. æª¢æŸ¥ Rate Limitï¼ˆAPI é€Ÿç‡é™åˆ¶ï¼‰
          elif echo "$ERROR_LOG" | grep -qi "rate.limit\|rate limit\|429"; then
            ERROR_TYPE="RATE_LIMIT"
            ERROR_DETAIL="API è«‹æ±‚é€Ÿç‡é™åˆ¶"
            NEXT_STEPS="
            1. é€™æ˜¯æš«æ™‚æ€§çš„é€Ÿç‡é™åˆ¶
            2. ç­‰å¾…å¹¾åˆ†é˜å¾Œé‡è©¦
            3. é€™ä¸æ˜¯æ¯æ—¥é¡åº¦å•é¡Œï¼Œè€Œæ˜¯çŸ­æ™‚é–“è«‹æ±‚éå¤š"
          
          # 3. æª¢æŸ¥èªè­‰éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "OAuth token revoked\|authentication.failed\|invalid.token\|401\|403"; then
            ERROR_TYPE="AUTHENTICATION"
            ERROR_DETAIL="
            1. æª¢æŸ¥ GitHub App å®‰è£ç‹€æ…‹ï¼šhttps://github.com/settings/installations
            2. ç¢ºèªã€ŒClaude Codeã€App å·²å®‰è£ä¸”æœ‰æ¬Šé™å­˜å–æ­¤ repository
            3. æª¢æŸ¥ repository secrets ä¸­æ˜¯å¦æœ‰ CLAUDE_CODE_OAUTH_TOKEN
            4. å¦‚æœå•é¡ŒæŒçºŒï¼Œå˜—è©¦é‡æ–°å®‰è£ Claude Code Appï¼š
               - ç§»é™¤ï¼šhttps://github.com/settings/installations
               - é‡æ–°å®‰è£ï¼šå¾ install-github-app é‡æ–°é€£çµ GitHub
            5. âš ï¸ æ³¨æ„ï¼šæ­¤ token ç”±ç³»çµ±è‡ªå‹•ç”¢ç”Ÿï¼Œç„¡æ³•åœ¨ claude.ai æ‰‹å‹•æŸ¥çœ‹æˆ–ç”¢ç”Ÿ"
          
          # 4. æª¢æŸ¥æ¬Šé™éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "permission.denied\|forbidden\|not.allowed"; then
            ERROR_TYPE="PERMISSION"
            ERROR_DETAIL="æ¬Šé™ä¸è¶³"
            NEXT_STEPS="
            1. æª¢æŸ¥ workflow æª”æ¡ˆä¸­çš„ permissions è¨­å®š
            2. ç¢ºèª GitHub token æœ‰è¶³å¤ æ¬Šé™
            3. æª¢æŸ¥ repository settings ä¸­çš„ Actions permissions"
          fi
          
          # é¡¯ç¤ºåˆ†é¡çµæœ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ "$ERROR_TYPE" != "UNKNOWN" ]; then
            echo "::error éŒ¯èª¤é¡å‹ï¼š$ERROR_TYPE::$ERROR_DETAIL"
            echo ""
            echo "**éŒ¯èª¤é¡å‹ï¼š$ERROR_TYPE**"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "**éŒ¯èª¤èªªæ˜ï¼š**"
            echo "$ERROR_DETAIL"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "â° **é¡åº¦é‡ç½®æ™‚é–“ï¼š** $RESET_TIME"
              echo ""
            fi
            echo "ğŸ”§ **å»ºè­°è™•ç†æ­¥é©Ÿï¼š**"
            echo "$NEXT_STEPS"
          else
            echo "::error æœªçŸ¥éŒ¯èª¤::ç„¡æ³•è‡ªå‹•åˆ†é¡æ­¤éŒ¯èª¤"
            echo ""
            echo "âš ï¸  **ç„¡æ³•è‡ªå‹•åˆ†é¡æ­¤éŒ¯èª¤**"
            echo ""
            echo "ğŸ“‹ **å»ºè­°æª¢æŸ¥æ­¥é©Ÿï¼š**"
            echo "1. æŸ¥çœ‹ä¸Šæ–¹ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡ºã€å€å¡Š"
            echo "2. å‰å¾€ https://claude.ai æª¢æŸ¥å¸³æˆ¶ç‹€æ…‹ï¼ˆæœ€å¸¸è¦‹åŸå› æ˜¯ä½¿ç”¨é¡åº¦ï¼‰"
            echo "3. æª¢æŸ¥ CLAUDE_CODE_OAUTH_TOKEN æ˜¯å¦æœ‰æ•ˆ"
            echo "4. å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹å°‡éŒ¯èª¤è¨Šæ¯è¤‡è£½åˆ° GitHub Issue"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "::notice::ğŸ’¡ å®Œæ•´çš„éŒ¯èª¤è¼¸å‡ºå·²æ‘ºç–Šåœ¨ä¸Šæ–¹ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡ºã€å€å¡Šä¸­"
          
          exit 1
          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/sdk#command-line for available options
          # claude_args: '--model claude-opus-4-1-20250805 --allowed-tools Bash(gh pr:*)'

