name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
        continue-on-error: true

      - name: Analyze Error
        if: steps.claude.outcome == 'failure'
        env:
          ERROR_OUTPUT: ${{ steps.claude.outputs.error }}
        run: |
          echo "::group::ğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)"
          echo "$ERROR_OUTPUT"
          echo "::endgroup::"
          
          echo ""
          echo "ğŸ” åˆ†æéŒ¯èª¤é¡å‹..."
          echo ""
          
          # å¾ JSON æå– result æ¬„ä½ï¼ˆéŒ¯èª¤è¨Šæ¯çš„ä¸»è¦ä¾†æºï¼‰
          RESULT_MESSAGE=""
          
          if [ -n "$ERROR_OUTPUT" ]; then
            # æ–¹æ³• 1: ä½¿ç”¨ grep + sed æå– "result" æ¬„ä½
            RESULT_MESSAGE=$(echo "$ERROR_OUTPUT" | grep -oP '"result"\s*:\s*"\K[^"]+' 2>/dev/null || echo "")
          fi
        
          echo "::group::ğŸ” æå–çš„éŒ¯èª¤è¨Šæ¯"
          echo "Result: $RESULT_MESSAGE"
          echo "::endgroup::"
          
          # åˆå§‹åŒ–è®Šæ•¸
          ERROR_TYPE="UNKNOWN"
          ERROR_DETAIL=""
          NEXT_STEPS=""
          RESET_TIME=""
          
          # ä½¿ç”¨ result è¨Šæ¯é€²è¡ŒéŒ¯èª¤åˆ†é¡
          ERROR_LOG="$RESULT_MESSAGE"
          
          # 1. OAuth Token Revoked - æœ€å¸¸è¦‹çš„èªè­‰å•é¡Œ
          if echo "$ERROR_LOG" | grep -qi "OAuth token revoked\|token revoked"; then
            ERROR_TYPE="ğŸ” OAUTH_REVOKED"
            ERROR_DETAIL="OAuth Token å·²è¢«æ’¤éŠ·æˆ–å¤±æ•ˆ"
            NEXT_STEPS="
            1. æª¢æŸ¥ GitHub App å®‰è£ç‹€æ…‹ï¼šhttps://github.com/settings/installations
            2. ç¢ºèªã€ŒClaude Codeã€App å·²å®‰è£ä¸”æœ‰æ¬Šé™å­˜å–æ­¤ repository
            3. æª¢æŸ¥ repository secrets ä¸­æ˜¯å¦æœ‰ CLAUDE_CODE_OAUTH_TOKEN
            4. å¦‚æœå•é¡ŒæŒçºŒï¼Œå˜—è©¦é‡æ–°å®‰è£ Claude Code Appï¼š
               - ç§»é™¤ï¼šhttps://github.com/settings/installations
               - é‡æ–°å®‰è£ï¼šå¾ install-github-app é‡æ–°é€£çµ GitHub
            5. âš ï¸ æ³¨æ„ï¼šæ­¤ token ç”±ç³»çµ±è‡ªå‹•ç”¢ç”Ÿï¼Œç„¡æ³•åœ¨ claude.ai æ‰‹å‹•æŸ¥çœ‹æˆ–ç”¢ç”Ÿ"
          
          # 2. Session Limit - æ¯æ—¥ä½¿ç”¨é¡åº¦
          elif echo "$ERROR_LOG" | grep -qi "session.limit\|session limit reached\|session limit\|usage limit"; then
            ERROR_TYPE="â° SESSION_LIMIT"
            ERROR_DETAIL="Claude æ¯æ—¥ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™"
            
            # å˜—è©¦æå–é‡ç½®æ™‚é–“
            RESET_TIME=$(echo "$ERROR_LOG" | grep -oP "resets.*?(\d+[ap]m)" | head -n1)
            if [ -z "$RESET_TIME" ]; then
              RESET_TIME=$(echo "$ERROR_LOG" | grep -oP "\d+[ap]m" | head -n1)
            fi
            
            NEXT_STEPS="
            1. å‰å¾€ https://claude.ai æŸ¥çœ‹è©³ç´°ä½¿ç”¨ç‹€æ…‹
            2. ç­‰å¾…ä½¿ç”¨é¡åº¦é‡ç½®"
              if [ -n "$RESET_TIME" ]; then
                NEXT_STEPS="${NEXT_STEPS}ï¼ˆé è¨ˆé‡ç½®æ™‚é–“ï¼š$RESET_TIMEï¼‰"
              fi
              NEXT_STEPS="${NEXT_STEPS}
            3. æˆ–è€ƒæ…®å‡ç´šåˆ°æ›´é«˜æ–¹æ¡ˆä»¥ç²å¾—æ›´å¤šé¡åº¦"
          
          # 3. Rate Limit - API é€Ÿç‡é™åˆ¶
          elif echo "$ERROR_LOG" | grep -qi "rate.limit\|rate limit\|429\|too many requests"; then
            ERROR_TYPE="ğŸš¦ RATE_LIMIT"
            ERROR_DETAIL="API è«‹æ±‚é€Ÿç‡é™åˆ¶ï¼ˆæš«æ™‚æ€§ï¼‰"
            NEXT_STEPS="
            1. é€™æ˜¯æš«æ™‚æ€§çš„é€Ÿç‡é™åˆ¶
            2. ç­‰å¾…å¹¾åˆ†é˜å¾Œé‡è©¦
            3. é€™ä¸æ˜¯æ¯æ—¥é¡åº¦å•é¡Œï¼Œè€Œæ˜¯çŸ­æ™‚é–“è«‹æ±‚éå¤š"
          
          # 4. ä¸€èˆ¬èªè­‰éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "unauthorized\|authentication.*failed\|invalid.*token\|401\|403"; then
            ERROR_TYPE="ğŸ”’ AUTHENTICATION"
            ERROR_DETAIL="èªè­‰å¤±æ•—"
            NEXT_STEPS="
            1. æª¢æŸ¥ GitHub App å®‰è£ç‹€æ…‹ï¼šhttps://github.com/settings/installations
            2. ç¢ºèªã€ŒClaude Codeã€App å·²å®‰è£ä¸”æœ‰æ¬Šé™å­˜å–æ­¤ repository
            3. æª¢æŸ¥ repository secrets ä¸­æ˜¯å¦æœ‰ CLAUDE_CODE_OAUTH_TOKEN
            4. å¦‚æœå•é¡ŒæŒçºŒï¼Œå˜—è©¦é‡æ–°å®‰è£ Claude Code Appï¼š
               - ç§»é™¤ï¼šhttps://github.com/settings/installations
               - é‡æ–°å®‰è£ï¼šå¾ install-github-app é‡æ–°é€£çµ GitHub
            5. âš ï¸ æ³¨æ„ï¼šæ­¤ token ç”±ç³»çµ±è‡ªå‹•ç”¢ç”Ÿï¼Œç„¡æ³•åœ¨ claude.ai æ‰‹å‹•æŸ¥çœ‹æˆ–ç”¢ç”Ÿ"
          
          # 5. æ¬Šé™éŒ¯èª¤
          elif echo "$ERROR_LOG" | grep -qi "permission.*denied\|forbidden\|not.*allowed"; then
            ERROR_TYPE="â›” PERMISSION"
            ERROR_DETAIL="æ¬Šé™ä¸è¶³"
            NEXT_STEPS="
            1. æª¢æŸ¥ workflow æª”æ¡ˆä¸­çš„ permissions è¨­å®š
            2. ç¢ºèª GitHub token æœ‰è¶³å¤ æ¬Šé™
            3. æª¢æŸ¥ repository settings ä¸­çš„ Actions permissions"
          
          # 6. å…¶ä»–åŒ…å« "error" çš„è¨Šæ¯
          elif echo "$ERROR_LOG" | grep -qi "error"; then
            ERROR_TYPE="âš ï¸  GENERAL_ERROR"
            ERROR_DETAIL="ç™¼ç”ŸéŒ¯èª¤"
            NEXT_STEPS="1. ğŸ“‹ æŸ¥çœ‹ä¸Šæ–¹å®Œæ•´éŒ¯èª¤è¨Šæ¯
          2. ğŸ” å¸¸è¦‹åŸå› æª¢æŸ¥ï¼š
             - OAuth token å•é¡Œ â†’ åŸ·è¡Œ 'claude code /login'
             - ä½¿ç”¨é¡åº¦å•é¡Œ â†’ å‰å¾€ https://claude.ai æŸ¥çœ‹
             - ç¶²è·¯æˆ– API å•é¡Œ â†’ ç¨å¾Œé‡è©¦"
          fi
          
          # é¡¯ç¤ºåˆ†é¡çµæœ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ "$ERROR_TYPE" != "UNKNOWN" ]; then
            echo "::error title=$ERROR_TYPE::$ERROR_DETAIL"
            echo ""
            echo "# ğŸš¨ $ERROR_TYPE"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
            echo ""
            echo "\`\`\`"
            echo "$RESULT_MESSAGE"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ’¡ èªªæ˜"
            echo ""
            echo "$ERROR_DETAIL"
            echo ""
            if [ -n "$RESET_TIME" ]; then
              echo "â° **é‡ç½®æ™‚é–“ï¼š** \`$RESET_TIME\`"
              echo ""
            fi
            echo "## ğŸ”§ è™•ç†æ­¥é©Ÿ"
            echo ""
            echo "$NEXT_STEPS"
          else
            echo "::warning title=æœªåˆ†é¡éŒ¯èª¤::è«‹æŸ¥çœ‹å®Œæ•´éŒ¯èª¤è¼¸å‡º"
            echo ""
            echo "# âš ï¸  ç„¡æ³•è‡ªå‹•åˆ†é¡æ­¤éŒ¯èª¤"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            if [ -n "$RESULT_MESSAGE" ]; then
              echo "## ğŸ“ éŒ¯èª¤è¨Šæ¯"
              echo ""
              echo "\`\`\`"
              echo "$RESULT_MESSAGE"
              echo "\`\`\`"
              echo ""
            fi
            echo "## ğŸ“‹ å»ºè­°æª¢æŸ¥æ­¥é©Ÿ"
            echo ""
            echo "1. ğŸ“„ æŸ¥çœ‹ä¸Šæ–¹ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)ã€å€å¡Š"
            echo "2. ğŸ” æœ€å¸¸è¦‹å•é¡Œï¼š"
            echo "   - OAuth Token å¤±æ•ˆ â†’ åŸ·è¡Œ \`claude code /login\`"
            echo "   - ä½¿ç”¨é¡åº¦ä¸è¶³ â†’ https://claude.ai"
            echo "3. ğŸ› å¦‚å•é¡ŒæŒçºŒï¼Œè«‹å°‡å®Œæ•´éŒ¯èª¤è²¼åˆ° GitHub Issue"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "::notice::ğŸ’¡ å®Œæ•´çš„ JSON éŒ¯èª¤è¼¸å‡ºå·²æ‘ºç–Šåœ¨ã€ŒğŸ“‹ å®Œæ•´éŒ¯èª¤è¼¸å‡º (JSON)ã€å€å¡Šä¸­"
          
          exit 1

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/sdk#command-line for available options
          # claude_args: '--model claude-opus-4-1-20250805 --allowed-tools Bash(gh pr:*)'

