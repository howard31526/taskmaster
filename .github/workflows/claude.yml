name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        timeout-minutes: 15
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          claude_args: --max-turns 20
        continue-on-error: true

      # ============================================================
      # éšæ®µä¸€ï¼šæª¢æŸ¥æ˜¯å¦ç‚º Claude Code ç³»çµ±ç´šéŒ¯èª¤
      # ============================================================
      - name: Check Error Type
        id: error_check
        if: steps.claude.outcome == 'failure'
        run: |
          EXECUTION_FILE="${{ steps.claude.outputs.execution_file }}"
          
          # æª¢æŸ¥ execution file æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXECUTION_FILE" ]; then
            echo "error_type=SYSTEM_FAILURE" >> $GITHUB_OUTPUT
            echo "error_message=Execution file not found - possible system failure" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–éŒ¯èª¤è¨Šæ¯
          RESULT_MESSAGE=$(grep -oP '"result"\s*:\s*"\K[^"]+' "$EXECUTION_FILE" | tail -n1)
          
          if [ -z "$RESULT_MESSAGE" ]; then
            echo "error_type=UNKNOWN" >> $GITHUB_OUTPUT
            echo "error_message=No error message found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "error_message=$RESULT_MESSAGE" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–·æ˜¯å¦ç‚º Claude Code ç³»çµ±ç´šéŒ¯èª¤ï¼ˆç„¡æ³•é‹ä½œï¼‰
          if echo "$RESULT_MESSAGE" | grep -qi "OAuth token revoked\|token revoked"; then
            echo "error_type=OAUTH_REVOKED" >> $GITHUB_OUTPUT
          elif echo "$RESULT_MESSAGE" | grep -qi "session.limit\|session limit\|usage limit"; then
            echo "error_type=SESSION_LIMIT" >> $GITHUB_OUTPUT
          elif echo "$RESULT_MESSAGE" | grep -qi "rate.limit\|rate limit\|429"; then
            echo "error_type=RATE_LIMIT" >> $GITHUB_OUTPUT
          elif echo "$RESULT_MESSAGE" | grep -qi "unauthorized\|authentication.*failed\|invalid.*token\|401\|403"; then
            echo "error_type=AUTH_FAILED" >> $GITHUB_OUTPUT
          else
            # ä¸æ˜¯ç³»çµ±ç´šéŒ¯èª¤ï¼Œæ˜¯ä»»å‹™åŸ·è¡Œå¤±æ•— - å¯ä»¥è®“ Claude åˆ†æ
            echo "error_type=TASK_FAILURE" >> $GITHUB_OUTPUT
          fi

      # ============================================================
      # éšæ®µäºŒAï¼šè™•ç†ç³»çµ±ç´šéŒ¯èª¤ï¼ˆç”¨é è¨­è¦å‰‡ï¼‰
      # ============================================================
      - name: Handle System Error
        if: |
          steps.claude.outcome == 'failure' && 
          steps.error_check.outputs.error_type != 'TASK_FAILURE' &&
          steps.error_check.outputs.error_type != 'UNKNOWN'
        run: |
          ERROR_TYPE="${{ steps.error_check.outputs.error_type }}"
          ERROR_MESSAGE="${{ steps.error_check.outputs.error_message }}"
          
          # æ ¹æ“šéŒ¯èª¤é¡å‹ç”Ÿæˆå ±å‘Š
          case "$ERROR_TYPE" in
            "OAUTH_REVOKED")
              TITLE="ğŸ” OAuth Token å·²æ’¤éŠ·"
              DESCRIPTION="ä½ çš„ Claude Code OAuth token å·²è¢«æ’¤éŠ·æˆ–å¤±æ•ˆ"
              SOLUTION="1. åœ¨æœ¬åœ°çµ‚ç«¯åŸ·è¡Œï¼š\`claude code /login\`
          2. å®Œæˆ OAuth æˆæ¬Šæµç¨‹
          3. ç¢ºèª GitHub App å·²å®‰è£ï¼šhttps://github.com/settings/installations
          4. é‡æ–°è§¸ç™¼æ­¤ workflow"
              DOCS="- [Claude Code è¨­å®š](https://docs.claude.com/en/docs/claude-code/github-actions)
          - [GitHub App ç®¡ç†](https://github.com/settings/installations)"
              ;;
            
            "SESSION_LIMIT")
              RESET_TIME=$(echo "$ERROR_MESSAGE" | grep -oP "\d+[ap]m" | head -n1)
              TITLE="â° ä½¿ç”¨é¡åº¦å·²é”ä¸Šé™"
              DESCRIPTION="Claude æ¯æ—¥ä½¿ç”¨é¡åº¦å·²ç”¨å®Œ"
              SOLUTION="1. æŸ¥çœ‹ä½¿ç”¨ç‹€æ…‹ï¼šhttps://claude.ai
          2. ç­‰å¾…é¡åº¦é‡ç½®"
              if [ -n "$RESET_TIME" ]; then
                SOLUTION="$SOLUTIONï¼ˆé è¨ˆ $RESET_TIME é‡ç½®ï¼‰"
              fi
              SOLUTION="$SOLUTION
          3. è€ƒæ…®å‡ç´šæ–¹æ¡ˆï¼šhttps://claude.ai/settings/plan"
              DOCS="- [Claude å®šåƒ¹æ–¹æ¡ˆ](https://www.anthropic.com/pricing)"
              ;;
            
            "RATE_LIMIT")
              TITLE="ğŸš¦ API é€Ÿç‡é™åˆ¶"
              DESCRIPTION="çŸ­æ™‚é–“å…§è«‹æ±‚éå¤šï¼Œè§¸ç™¼é€Ÿç‡ä¿è­·"
              SOLUTION="1. ç­‰å¾… 2-5 åˆ†é˜
          2. é‡æ–°è§¸ç™¼ workflow
          3. é€™æ˜¯æš«æ™‚æ€§é™åˆ¶ï¼Œä¸æ˜¯æ¯æ—¥é¡åº¦å•é¡Œ"
              DOCS="- [API é€Ÿç‡é™åˆ¶èªªæ˜](https://docs.anthropic.com/rate-limits)"
              ;;
            
            "AUTH_FAILED")
              TITLE="ğŸ”’ èªè­‰å¤±æ•—"
              DESCRIPTION="ç„¡æ³•é€šéèº«ä»½é©—è­‰"
              SOLUTION="1. æª¢æŸ¥ GitHub App å®‰è£ï¼šhttps://github.com/settings/installations
          2. ç¢ºèª repository secrets è¨­å®š
          3. å˜—è©¦é‡æ–°åŸ·è¡Œ \`claude code /login\`"
              DOCS="- [èªè­‰è¨­å®šæŒ‡å—](https://docs.claude.com/en/docs/claude-code/github-actions)"
              ;;
          esac
          
          # ç”Ÿæˆ Markdown å ±å‘Š
          REPORT=$(cat <<EOF
          ## $TITLE
          
          ---
          
          ### ğŸ“ éŒ¯èª¤è¨Šæ¯
          
          \`\`\`
          $ERROR_MESSAGE
          \`\`\`
          
          ---
          
          ### ğŸ’¡ å•é¡Œèªªæ˜
          
          $DESCRIPTION
          
          ---
          
          ### ğŸ”§ è§£æ±ºæ–¹æ¡ˆ
          
          $SOLUTION
          
          ---
          
          ### ğŸ“š ç›¸é—œè³‡æº
          
          $DOCS
          
          ---
          
          <details>
          <summary>ğŸ” æŸ¥çœ‹è©³ç´°æ—¥èªŒ</summary>
          
          [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          </details>
          EOF
          )
          
          # ç™¼å¸ƒè©•è«–åˆ° GitHub
          if [ "${{ github.event_name }}" = "issues" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "$REPORT" | gh issue comment ${{ github.event.issue.number }} --body-file - --repo ${{ github.repository }}
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            echo "$REPORT" | gh pr comment ${{ github.event.pull_request.number }} --body-file - --repo ${{ github.repository }}
          fi
          
          echo "âœ… å·²åœ¨ GitHub ç™¼å¸ƒç³»çµ±éŒ¯èª¤å ±å‘Š"
          exit 0
        env:
          GH_TOKEN: ${{ github.token }}

      # ============================================================
      # éšæ®µäºŒBï¼šè®“ Claude åˆ†æä»»å‹™å¤±æ•—ï¼ˆæ™ºèƒ½åˆ†æï¼‰
      # ============================================================
      - name: Analyze Task Failure with Claude
        if: |
          steps.claude.outcome == 'failure' && 
          steps.error_check.outputs.error_type == 'TASK_FAILURE'
        timeout-minutes: 5
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: --max-turns 10
          prompt: |
            å‰›æ‰åŸ·è¡Œ Claude Code æ™‚ä»»å‹™å¤±æ•—äº†ã€‚è«‹å¹«æˆ‘åˆ†æå¤±æ•—åŸå› ä¸¦æä¾›è§£æ±ºæ–¹æ¡ˆã€‚
            
            ## èƒŒæ™¯è³‡è¨Š
            
            - **åŸ·è¡Œè¼¸å‡ºæª”æ¡ˆï¼š** ${{ steps.claude.outputs.execution_file }}
            - **Repositoryï¼š** ${{ github.repository }}
            - **Eventï¼š** ${{ github.event_name }}
            - **Actorï¼š** @${{ github.actor }}
            
            ## ä»»å‹™èªªæ˜
            
            ### æ­¥é©Ÿ 1ï¼šè®€å–ä¸¦åˆ†æåŸ·è¡Œæ—¥èªŒ
            
            1. è®€å–åŸ·è¡Œè¼¸å‡ºæª”æ¡ˆ
            2. åˆ†æ JSON å…§å®¹ï¼Œç‰¹åˆ¥æ³¨æ„ï¼š
               - `result` æ¬„ä½çš„éŒ¯èª¤è¨Šæ¯
               - `num_turns` - åŸ·è¡Œäº†å¹¾è¼ªå°è©±
               - `duration_ms` - åŸ·è¡Œæ™‚é•·
               - æ˜¯å¦æœ‰ timeout ç›¸é—œè¨Šæ¯
               - æ˜¯å¦æœ‰ç¨‹å¼éŒ¯èª¤ã€ç·¨è­¯éŒ¯èª¤ç­‰
            
            ### æ­¥é©Ÿ 2ï¼šè¨ºæ–·å•é¡Œ
            
            å¯èƒ½çš„ä»»å‹™å¤±æ•—åŸå› ï¼š
            - **Timeout**ï¼šåŸ·è¡Œæ™‚é–“éé•·ï¼ˆè¶…é 15 åˆ†é˜ï¼‰
            - **ç¨‹å¼éŒ¯èª¤**ï¼šèªæ³•éŒ¯èª¤ã€runtime error
            - **æ¸¬è©¦å¤±æ•—**ï¼šå–®å…ƒæ¸¬è©¦æˆ–æ•´åˆæ¸¬è©¦å¤±æ•—
            - **ç·¨è­¯éŒ¯èª¤**ï¼šç·¨è­¯å¤±æ•—
            - **æ¬Šé™å•é¡Œ**ï¼šç„¡æ³•è®€å¯«ç‰¹å®šæª”æ¡ˆ
            - **ä¾è³´å•é¡Œ**ï¼šç¼ºå°‘å¿…è¦çš„å¥—ä»¶æˆ–å·¥å…·
            - **é‚è¼¯éŒ¯èª¤**ï¼šç¨‹å¼é‚è¼¯æœ‰å•é¡Œ
            - **ç’°å¢ƒå•é¡Œ**ï¼šç’°å¢ƒè¨­å®šä¸æ­£ç¢º
            
            ### æ­¥é©Ÿ 3ï¼šæä¾›è§£æ±ºæ–¹æ¡ˆ
            
            æ ¹æ“šè¨ºæ–·çµæœï¼Œæä¾›ï¼š
            1. **å•é¡Œæ ¹å› åˆ†æ**ï¼ˆæŠ€è¡“å±¤é¢çš„è§£é‡‹ï¼‰
            2. **å…·é«”ä¿®å¾©æ­¥é©Ÿ**ï¼ˆå¯æ“ä½œçš„æŒ‡ä»¤æˆ–ä»£ç¢¼ï¼‰
            3. **é é˜²å»ºè­°**ï¼ˆé¿å…å†æ¬¡ç™¼ç”Ÿï¼‰
            
            ### æ­¥é©Ÿ 4ï¼šç™¼å¸ƒåˆ†æå ±å‘Š
            
            ä½¿ç”¨ `gh` CLI åœ¨åŸå§‹ issue/PR ç™¼å¸ƒè©•è«–ï¼š
            
            ```bash
            # æ ¹æ“š event é¡å‹é¸æ“‡æ­£ç¢ºçš„æŒ‡ä»¤
            gh issue comment <NUMBER> --body "..." --repo ${{ github.repository }}
            # æˆ–
            gh pr comment <NUMBER> --body "..." --repo ${{ github.repository }}
            ```
            
            è©•è«–æ ¼å¼ï¼ˆMarkdownï¼‰ï¼š
            
            ```markdown
            ## ğŸ” ä»»å‹™åŸ·è¡Œå¤±æ•—åˆ†æ
            
            ---
            
            ### ğŸ“Š åŸ·è¡Œè³‡è¨Š
            
            - **åŸ·è¡Œè¼ªæ•¸ï¼š** [num_turns]
            - **åŸ·è¡Œæ™‚é•·ï¼š** [duration_ms] ms
            - **å¤±æ•—æ™‚é–“ï¼š** [timestamp]
            
            ---
            
            ### âš ï¸ éŒ¯èª¤æ‘˜è¦
            
            [ç”¨ 1-2 å¥è©±æ¦‚æ‹¬å•é¡Œ]
            
            **éŒ¯èª¤è¨Šæ¯ï¼š**
            ```
            [é—œéµéŒ¯èª¤è¨Šæ¯]
            ```
            
            ---
            
            ### ğŸ”¬ å•é¡Œè¨ºæ–·
            
            **å•é¡Œé¡å‹ï¼š** [Timeout / ç¨‹å¼éŒ¯èª¤ / æ¸¬è©¦å¤±æ•— / ç­‰]
            
            **æ ¹æœ¬åŸå› ï¼š**
            [è©³ç´°è§£é‡‹ç‚ºä»€éº¼æœƒå¤±æ•—]
            
            **å½±éŸ¿ç¯„åœï¼š**
            [èªªæ˜é€™å€‹å•é¡Œå½±éŸ¿äº†ä»€éº¼]
            
            ---
            
            ### ğŸ’Š è§£æ±ºæ–¹æ¡ˆ
            
            #### å»ºè­°ä¿®å¾©æ­¥é©Ÿï¼š
            
            1. [å…·é«”æ­¥é©Ÿ 1]
               ```bash
               [ç›¸é—œæŒ‡ä»¤]
               ```
            
            2. [å…·é«”æ­¥é©Ÿ 2]
               ```python
               [ç›¸é—œä»£ç¢¼]
               ```
            
            3. [å…·é«”æ­¥é©Ÿ 3]
            
            ---
            
            ### ğŸ›¡ï¸ é é˜²å»ºè­°
            
            - [å»ºè­° 1]
            - [å»ºè­° 2]
            - [å»ºè­° 3]
            
            ---
            
            ### ğŸ”— ç›¸é—œè³‡æº
            
            - [ç›¸é—œæ–‡æª”æˆ–åƒè€ƒè³‡æ–™]
            
            ---
            
            <details>
            <summary>ğŸ“‹ å®Œæ•´åŸ·è¡Œæ—¥èªŒ</summary>
            
            [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            </details>
            ```
            
            ## é‡è¦æç¤º
            
            - ä½¿ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«
            - ç¢ºä¿åˆ†æåŸºæ–¼å¯¦éš›çš„åŸ·è¡Œæ—¥èªŒï¼Œä¸è¦çŒœæ¸¬
            - æä¾›çš„è§£æ±ºæ–¹æ¡ˆè¦å…·é«”å¯æ“ä½œ
            - å¦‚æœæ¶‰åŠç¨‹å¼ç¢¼ä¿®æ”¹ï¼Œçµ¦å‡ºå…·é«”çš„ diff æˆ–ä»£ç¢¼ç‰‡æ®µ
            - Issue Number: ${{ github.event.issue.number }}
            - PR Number: ${{ github.event.pull_request.number }}

      # ============================================================
      # éšæ®µä¸‰ï¼šè™•ç†æœªçŸ¥éŒ¯èª¤
      # ============================================================
      - name: Handle Unknown Error
        if: |
          steps.claude.outcome == 'failure' && 
          steps.error_check.outputs.error_type == 'UNKNOWN'
        run: |
          REPORT=$(cat <<'EOF'
          ## âš ï¸ ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤
          
          Claude Code åŸ·è¡Œå¤±æ•—ï¼Œä½†ç„¡æ³•è‡ªå‹•è­˜åˆ¥éŒ¯èª¤é¡å‹ã€‚
          
          ### ğŸ” å»ºè­°æ’æŸ¥æ­¥é©Ÿ
          
          1. æŸ¥çœ‹ [å®Œæ•´åŸ·è¡Œæ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. æª¢æŸ¥ Claude Code æ˜¯å¦æ­£å¸¸é‹ä½œï¼š`claude code --version`
          3. ç¢ºèª OAuth token ç‹€æ…‹ï¼šhttps://claude.ai/settings/integrations
          4. å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹æäº¤ Issue åˆ°ï¼šhttps://github.com/anthropics/claude-code-action/issues
          
          ### ğŸ“ éŒ¯èª¤è¨Šæ¯
          
          ```
          ${{ steps.error_check.outputs.error_message }}
          ```
          EOF
          )
          
          if [ "${{ github.event_name }}" = "issues" ] || [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "$REPORT" | gh issue comment ${{ github.event.issue.number }} --body-file - --repo ${{ github.repository }}
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            echo "$REPORT" | gh pr comment ${{ github.event.pull_request.number }} --body-file - --repo ${{ github.repository }}
          fi
        env:
          GH_TOKEN: ${{ github.token }}
