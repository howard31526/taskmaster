---
allowed-tools: Bash(git fetch:*), Bash(git status:*), Bash(git config:*), Bash(git branch:*), Bash(git diff:*), Bash(git pull:*), Bash(git push:*), Bash(git log:*), Read, Write
argument-hint: <目標分支>
description: 上傳前的自動化分支檢查與安全推送
---

# 共用流程
@.claude/commands/branch-merge.md
@.claude/commands/pack-zh.md

# 上傳前分支檢查與自動化推送

1. **第一步：確認分支狀態**
  - 當前分支：!`git branch --show-current`
  - 顯示所有分支：!`git branch -a`
  - 目標分支：$1

  判斷當前分支與目標分支關係：
  - 若相同 → 進入正常推送流程
  - 若不同 → 詢問：「您目前在 [當前分支] 但要推送到 [目標分支]，這將執行跨分支推送。請選擇：
    [1] 確認跨分支推送
    [2] 切換到目標分支
    [3] 建立新的遠端分支

  > 請等待我回復選項再進行下一步。

2. **第二步：檢查本地狀態與安全檢查**
  - 顯示工作目錄狀態：!`git status -s`

  **2.1 Git忽略檔案檢查**
  - 檢查 `.gitignore` 檔案是否存在
    **情況A：`.gitignore` 不存在（首次設定）**
    - 詢問是否建立基礎 `.gitignore` 規則（是/否）

    > 請等待我回復再進行下一步。

      - 若選擇「是」→ 建立 `.gitignore` 檔案
      - **重要**：檢查歷史提交中的敏感檔案
        - 使用指令：!`git ls-files -ic --exclude-standard`
        - 若發現敏感檔案在歷史提交中，警告使用者：
          ```
          ⚠️  發現以下敏感檔案已在歷史提交中：
          [檔案清單]

          這些檔案需要從Git歷史中完全移除，否則推送後仍可被他人存取。
          是否要清理Git歷史並移除這些敏感檔案？（是/否）

          注意：此操作會重寫Git歷史，需要強制推送。
          ```
          - 若選擇「是」→ 移除追蹤 + 提交清理
          - 若選擇「否」→ 繼續但警告風險

        > 請等待我回復再進行下一步。

    **情況B：`.gitignore` 已存在（後續推送）**
      - 跳過敏感檔案檢查（因為 `.gitignore` 會自動防止追蹤新的敏感檔案）
      - 注意：如果使用者修改了 `.gitignore` 規則，可手動執行 `git ls-files -ic --exclude-standard` 檢查是否有需要移除追蹤的舊檔案
    > 請等待我回復 繼續 再進行下一步。

  **2.2 未提交變更檢查**
  - 若發現未追蹤或未提交的檔案，詢問：「發現未提交的變更，是否要先提交？（是/否）」
    - 若選擇「是」→ 呼叫 `/pack-zh` 進行提交，結束後繼續推送流程
    - 若選擇「否」→ 繼續推送流程

  > 請等待我回復再進行下一步。

3. **第三步：檢查遠端同步**
  請再次確認[當前分支]和[目標分支]和我一開始要求推送的是一樣的參數內容。
  僅在當前分支 = 目標分支時執行同步檢查：
  - 取得遠端最新狀態：!`git fetch origin`
  - 檢查本地與遠端的關係：!`git status -uno`

  若本地分支落後於遠端，詢問：「本地分支落後於遠端，需要同步後才能推送。請選擇處理方式：
  [1] 使用 /branch-merge 進行安全合併（推薦）
  [2] 嘗試 rebase（可能有衝突風險）
  [3] 手動處理（取消推送）


  > 請等待我回復選項再進行下一步。

  若本地分支超前或同步 → 可直接推送
  若當前分支 ≠ 目標分支 → 跳過同步檢查，直接推送

4. **第四步：執行推送**

  根據分支關係執行推送：
  - 若當前分支 = 目標分支 → 執行：`git push origin [分支名]`
  - 若當前分支 ≠ 目標分支 → 執行：`git push origin [當前分支]:[目標分支]`

  **若推送被拒絕**：
  - 立即取得遠端最新狀態：`git fetch origin`
  - 詢問：「推送被拒絕，遠端分支有新提交。請選擇處理方式：
    [1] 使用 /branch-merge 進行安全合併（推薦）
    [2] 嘗試 rebase（可能有衝突風險）
    [3] 手動處理（取消推送）

  > 請等待我回復選項再進行處理。

5. **第五步：推送成功報告**

  推送成功後，詢問：「推送完成！是否要生成推送報告？（是/否）」

  若選擇「是」→ 生成報告包含：
  - 當前日期：使用 `date +"%Y-%m-%d %H:%M:%S"`
  - 推送分支資訊
  - 本地操作者：使用 `git config user.name`
  - 此次推送的 commit 紀錄（前 5 筆）：使用 `git log --oneline -5`
  - 輸出至 `push_logs/YYYYMMDD_HH-MM_push_[分支名].md`

  > 請等待我確認是否生成報告。

---

# 推送安全規範
- 禁止自動使用 `--force`，除非使用者明確輸入「force」
- 若出現推送被拒絕的錯誤，必須提示先行同步遠端再推送
- 所有操作都需要用戶確認後才執行
